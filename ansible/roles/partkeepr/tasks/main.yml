---
- name: create required partkeepr volumes
  community.general.docker_volume:
    name: "{{ item }}"
  with_items:
    - partkeepr-web-vol
    - partkeepr-conf-vol
    - partkeepr-data-vol
    - partkeepr-db-vol
  tags: partkeepr

- name: create partkeepr network
  community.general.docker_network:
    name: "partkeepr"
  tags: partkeepr

- name: create partkeepr-db container
  diff: false
  community.general.docker_container:
    name: partkeepr-db
    image: mariadb:10.0
    recreate: false
    restart: true
    restart_policy: unless-stopped
    restart_retries: 3
    log_driver: syslog
    log_options:
      syslog-address: "udp://localhost:{{ syslog_udp_default }}"
      syslog-facility: daemon
      tag: "docker/{{'{{'}}.Name{{'}}'}}"
    networks:
      - name: "partkeepr"
    env:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_DATABASE: partkeepr
      MYSQL_USER: partkeepr
      MYSQL_PASSWORD: partkeepr
    volumes:
      - partkeepr-db-vol:/var/lib/mysql
  tags: partkeepr

- name: create partkeepr container
  diff: false
  community.general.docker_container:
    name: partkeepr
    image: mhubig/partkeepr:latest
    recreate: false
    restart: true
    restart_policy: unless-stopped
    restart_retries: 3
    log_driver: syslog
    log_options:
      syslog-address: "udp://localhost:{{ syslog_udp_default }}"
      syslog-facility: daemon
      tag: "docker/{{'{{'}}.Name{{'}}'}}"
    networks:
      - name: "partkeepr"
    ports:
      - "8081:80"
    volumes:
      - partkeepr-db-conf-vol:/var/www/html/app/config
      - partkeepr-db-data-vol:/var/www/html/data
      - partkeepr-db-web-vol:/var/www/html/web
  tags: partkeepr

- name: create partkeepr-cron container
  diff: false
  community.general.docker_container:
    name: partkeepr-cron
    image: mhubig/partkeepr:latest
    command_handling: correct
    entrypoint: []
    command: bash -c "crontab /etc/cron.d/partkeepr && cron -f"
    recreate: false
    restart: true
    restart_policy: unless-stopped
    restart_retries: 3
    log_driver: syslog
    log_options:
      syslog-address: "udp://localhost:{{ syslog_udp_default }}"
      syslog-facility: daemon
      tag: "docker/{{'{{'}}.Name{{'}}'}}"
    volumes:
      - partkeepr-db-conf-vol:/var/www/html/app/config:ro
      - partkeepr-db-data-vol:/var/www/html/data
      - partkeepr-db-web-vol:/var/www/html/web
  tags: partkeepr
